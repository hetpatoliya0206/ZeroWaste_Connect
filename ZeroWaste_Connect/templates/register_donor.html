<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Donor | ZeroWaste Connect</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='register_restaurant.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
    <main class="auth-shell">

        <!-- ‚îÄ‚îÄ Left hero panel ‚îÄ‚îÄ -->
        <section class="hero-panel reveal-up">
            <p class="eyebrow">Join the Network</p>
            <h1>Register as a Donor</h1>
            <p class="subtitle">Start donating surplus food today and help to reduce local waste.</p>
            <ul class="bullet-list">
                <li>Automated NGO matching</li>
                <li>Real-time distance calculation</li>
                <li>Impact tracking dashboard</li>
            </ul>
        </section>
    <!-- ‚îÄ‚îÄ Right form panel ‚îÄ‚îÄ -->
        <section class="form-panel reveal-up reveal-delay">
            <h2>Create Account</h2>

            {% with messages = get_flashed_messages() %}
              {% if messages %}
                {% for message in messages %}
                  <div class="flash">{{ message }}</div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <form method="POST" class="stack-form" onsubmit="return validateLocation()">

                <label for="name">Donor Name</label>
                <input id="name" type="text" name="name" placeholder="e.g. Shyam Mehta" required>

                <label for="password">Password</label>
                <div class="password-wrapper">
                    <input id="password" type="password" name="password" placeholder="Min. 8 characters" required>
                    <button type="button" class="toggle-pw" onclick="togglePassword('password', this)" title="Show/Hide password">
                        <svg id="eye-password" xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                        </svg>
                    </button>
                </div>

                <label for="phone">WhatsApp Phone Number</label>
                <input id="phone" type="tel" name="phone" placeholder="e.g. 919876543210">
                <p class="phone-hint">üì± Include country code, no + or spaces. India: 91XXXXXXXXXX</p>

                <label for="address">Location</label>
                <div class="autocomplete-wrapper">
                    <input id="address" type="text" placeholder="üîç Type your restaurant name or address..." autocomplete="off">
                    <div id="suggestions"></div>
                </div>
                <div id="address-status"></div>

                <div id="location-info">
                    <div class="loc-name" id="loc-name-text"></div>
                    <div class="loc-coords" id="loc-coords-text"></div>
                </div>

                <input type="hidden" id="latitude" name="latitude">
                <input type="hidden" id="longitude" name="longitude">

                <div id="map"></div>
                <p class="map-tip">üí° Select from the dropdown for exact location, or click the map to fine-tune.</p>

                <button type="submit">Register Donor</button>
            </form>

            <a class="text-link" href="{{ url_for('login') }}">Already have an account? Login</a>
        </section>

    </main>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        // ‚îÄ‚îÄ Show / Hide password ‚îÄ‚îÄ
        function togglePassword(fieldId, btn) {
            var input = document.getElementById(fieldId);
            var isHidden = input.type === 'password';
            input.type = isHidden ? 'text' : 'password';
            btn.innerHTML = isHidden
                ? '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.97 9.97 0 012.05-3.475M6.53 6.53A9.97 9.97 0 0112 5c4.477 0 8.268 2.943 9.542 7a9.97 9.97 0 01-4.423 5.366M3 3l18 18"/></svg>'
                : '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>';
        }

        // ‚îÄ‚îÄ Map ‚îÄ‚îÄ
        let map = L.map('map').setView([23.0225, 72.5714], 13);
        let marker;
        let searchTimeout;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        function setStatus(msg, color) {
            let el = document.getElementById("address-status");
            el.style.color = color || "#888";
            el.textContent = msg;
        }

        function setLocation(lat, lon, displayName) {
            if (marker) map.removeLayer(marker);
            marker = L.marker([lat, lon]).addTo(map);
            map.setView([lat, lon], 18);
            document.getElementById("latitude").value = lat;
            document.getElementById("longitude").value = lon;
            if (displayName) {
                let parts = displayName.split(",");
                document.getElementById("loc-name-text").textContent = "üìç " + parts.slice(0, 3).join(",").trim();
                document.getElementById("loc-coords-text").textContent =
                    `Lat: ${parseFloat(lat).toFixed(7)},  Lon: ${parseFloat(lon).toFixed(7)}`;
                document.getElementById("location-info").style.display = "block";
            }
        }

        function showSuggestions(results) {
            let box = document.getElementById("suggestions");
            box.innerHTML = "";
            if (!results || results.length === 0) { box.style.display = "none"; return; }
            results.forEach(item => {
                let div = document.createElement("div");
                div.className = "suggestion-item";
                let parts = item.display_name.split(",");
                div.innerHTML = `<div class="place-name">${parts.slice(0,2).join(",").trim()}</div><div class="place-addr">${parts.slice(2,5).join(",").trim()}</div>`;
                div.addEventListener("mousedown", function(e) {
                    e.preventDefault();
                    document.getElementById("address").value = item.display_name;
                    setLocation(parseFloat(item.lat), parseFloat(item.lon), item.display_name);
                    box.style.display = "none";
                    setStatus("‚úÖ Exact location selected!", "green");
                });
                box.appendChild(div);
            });
            box.style.display = "block";
        }

        document.getElementById("address").addEventListener("input", function() {
            let query = this.value.trim();
            clearTimeout(searchTimeout);
            if (query.length < 3) { document.getElementById("suggestions").style.display = "none"; setStatus("", ""); return; }
            setStatus("Searching...", "#2980b9");
            searchTimeout = setTimeout(() => {
                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=7&addressdetails=1&countrycodes=in`, {
                    headers: { "Accept-Language": "en", "User-Agent": "ZeroWasteApp/1.0" }
                })
                .then(res => res.json())
                .then(data => {
                    if (data && data.length > 0) { showSuggestions(data); setStatus("Select your exact location from the list ‚Üì", "#2980b9"); }
                    else { showSuggestions([]); setStatus("‚ùå No results. Try different keywords.", "red"); }
                })
                .catch(() => setStatus("‚ö†Ô∏è Search failed. Click on the map instead.", "orange"));
            }, 400);
        });

        document.getElementById("address").addEventListener("blur", function() {
            setTimeout(() => { document.getElementById("suggestions").style.display = "none"; }, 150);
        });

        document.addEventListener("click", function(e) {
            if (!e.target.closest(".autocomplete-wrapper")) document.getElementById("suggestions").style.display = "none";
        });

        map.on('click', function(e) {
            let lat = e.latlng.lat, lon = e.latlng.lng;
            setStatus("Fetching address...", "#2980b9");
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&zoom=18&addressdetails=1`, {
                headers: { "User-Agent": "ZeroWasteApp/1.0" }
            })
            .then(res => res.json())
            .then(data => {
                if (data && data.display_name) {
                    document.getElementById("address").value = data.display_name;
                    setLocation(lat, lon, data.display_name);
                    setStatus("‚úÖ Location updated from map click.", "green");
                }
            })
            .catch(() => { setLocation(lat, lon, null); setStatus("üìç Map location set.", "orange"); });
        });

        function validateLocation() {
            if (!document.getElementById("latitude").value || !document.getElementById("longitude").value) {
                alert("‚ö†Ô∏è Please search and select your restaurant location first.");
                return false;
            }
            return true;
        }
    </script>
</body>
</html>
